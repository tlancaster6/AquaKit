---
phase: 06-tech-debt-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - README.md
  - src/aquakit/projection/refractive.py
  - tests/e2e/__init__.py
  - tests/integration/__init__.py
autonomous: true

must_haves:
  truths:
    - "README Quick Start section mentions installing PyTorch as a prerequisite before hatch env create"
    - "RefractiveProjectionModel.back_project delegates to snells_law_3d instead of inline Snell's law math"
    - "Empty tests/e2e/ and tests/integration/ directories no longer exist"
  artifacts:
    - path: "README.md"
      provides: "PyTorch install note in Development section"
      contains: "pip install torch"
    - path: "src/aquakit/projection/refractive.py"
      provides: "back_project using snells_law_3d"
      contains: "snells_law_3d"
  key_links:
    - from: "src/aquakit/projection/refractive.py"
      to: "src/aquakit/refraction.py"
      via: "import snells_law_3d"
      pattern: "from \\.\\.refraction import.*snells_law_3d"
---

<objective>
Address three low-severity tech debt items flagged by the v1 milestone audit: (1) add a PyTorch install note to the README Development section, (2) replace the inline Snell's law copy in RefractiveProjectionModel.back_project with a call to snells_law_3d, and (3) remove the empty tests/e2e/ and tests/integration/ directories.

Purpose: Close tech debt from v1-MILESTONE-AUDIT.md so the codebase is clean for post-v1 development.
Output: Three files modified, two directories deleted, all existing tests still passing.
</objective>

<execution_context>
@C:/Users/tucke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/tucke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/v1-MILESTONE-AUDIT.md
@src/aquakit/projection/refractive.py
@src/aquakit/refraction.py
@README.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: README PyTorch note and empty test directory cleanup</name>
  <files>README.md, tests/e2e/__init__.py, tests/integration/__init__.py</files>
  <action>
1. **README.md** — In the Development section, add a PyTorch prerequisite note between the "Set up the development environment" comment and the `pip install hatch` line. Add these lines:

```
# Install PyTorch first (CPU example; see https://pytorch.org for CUDA builds)
pip install torch
```

This matches the Installation section's guidance and makes it clear that the hatch env alone does not provide torch.

2. **Delete empty test directories** — Remove `tests/e2e/` and `tests/integration/` directories entirely (each contains only an empty `__init__.py`). These were placeholder directories that were never populated; cross-phase integration is tested within the unit test suite.

Verify that no pytest configuration references these directories (conftest.py, pyproject.toml testpaths, etc.). If `pyproject.toml` has testpaths referencing them, remove those entries.
  </action>
  <verify>
- `hatch run test` passes (no test collection errors from missing directories)
- `ls tests/e2e tests/integration` returns "No such file or directory" for both
- README.md Development section contains "pip install torch"
  </verify>
  <done>README Development section includes PyTorch install prerequisite; tests/e2e/ and tests/integration/ directories are gone; test suite still passes.</done>
</task>

<task type="auto">
  <name>Task 2: Replace inline Snell's law in back_project with snells_law_3d call</name>
  <files>src/aquakit/projection/refractive.py</files>
  <action>
In `RefractiveProjectionModel.back_project`, replace the inline Snell's law block (lines 208-218 approximately) with a call to `snells_law_3d` from `aquakit.refraction`.

**Current inline code to replace** (the block starting at "# Snell's law: air-to-water refraction"):
```python
cos_i = -(rays_world * self.normal).sum(dim=-1)
n_oriented = -self.normal.unsqueeze(0)
sin_t_sq = self.n_ratio**2 * (1.0 - cos_i**2)
cos_t = torch.sqrt(torch.clamp(1.0 - sin_t_sq, min=0.0))
directions = (
    self.n_ratio * rays_world
    + (cos_t - self.n_ratio * cos_i).unsqueeze(-1) * n_oriented
)
directions = directions / torch.linalg.norm(directions, dim=-1, keepdim=True)
```

**Replace with:**
```python
directions, _ = snells_law_3d(rays_world, self.normal, self.n_ratio)
```

The `_` captures the validity mask which is always True for air-to-water (n_air < n_water means no TIR). The function auto-orients the normal internally, so passing `self.normal` directly is correct. The function returns unit vectors, so no extra normalization needed.

**Import change:** Add `snells_law_3d` to the existing import from `..refraction`:
```python
from ..refraction import refractive_project, snells_law_3d
```

**Docstring update:** Change the back_project docstring from "applies Snell's law (air-to-water) inline" to "applies Snell's law via snells_law_3d" (line 179 area).

**Important:** Do NOT change the `project()` method — it correctly delegates to `refractive_project` which already uses `snells_law_3d` internally.
  </action>
  <verify>
- `hatch run test` passes (all 226+ tests, especially test_refractive_projection and test_refractive_back_project)
- `hatch run typecheck` passes
- `grep -c "snells_law_3d" src/aquakit/projection/refractive.py` returns at least 1 (the import and the call)
- No inline cos_i/sin_t_sq/cos_t variables remain in back_project method
  </verify>
  <done>back_project delegates to snells_law_3d; no inline Snell's law copy remains; all tests and typecheck pass unchanged.</done>
</task>

</tasks>

<verification>
1. `hatch run test` — all tests pass (no regressions from Snell's law refactor or directory deletion)
2. `hatch run typecheck` — basedpyright clean
3. `hatch run lint` — ruff clean
4. README.md Development section mentions PyTorch install
5. `tests/e2e/` and `tests/integration/` no longer exist
6. `snells_law_3d` appears in refractive.py import and back_project body
</verification>

<success_criteria>
- All three tech debt items from v1-MILESTONE-AUDIT.md are resolved
- No test regressions
- No typecheck or lint regressions
</success_criteria>

<output>
After completion, create `.planning/phases/06-tech-debt-cleanup/06-01-SUMMARY.md`
</output>
