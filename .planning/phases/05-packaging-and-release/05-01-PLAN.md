---
phase: 05-packaging-and-release
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - src/aquacore/*.py
autonomous: true

must_haves:
  truths:
    - "basedpyright passes at 'standard' strictness with 0 errors"
    - "CI test workflow passes on current codebase (lint, typecheck, pytest)"
    - "CI publish workflow structure is correct for trusted publishing"
  artifacts:
    - path: "pyproject.toml"
      provides: "basedpyright standard mode config"
      contains: 'typeCheckingMode = "standard"'
  key_links:
    - from: "pyproject.toml"
      to: ".github/workflows/test.yml"
      via: "hatch run typecheck uses basedpyright config"
      pattern: "hatch run typecheck"
---

<objective>
Bump basedpyright from "basic" to "standard" strictness and validate all CI workflows are correct for the current codebase.

Purpose: The "standard" strictness level catches 5 additional error classes (reportFunctionMemberAccess, reportIncompatibleMethodOverride, reportIncompatibleVariableOverride, reportOverlappingOverload, reportPossiblyUnboundVariable). Validating CI ensures the existing workflows work end-to-end before configuring branch protection.
Output: pyproject.toml with standard mode, any source fixes, validated CI workflows.
</objective>

<execution_context>
@C:/Users/tucke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/tucke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-packaging-and-release/05-RESEARCH.md
@pyproject.toml
@.github/workflows/test.yml
@.github/workflows/publish.yml
@.github/workflows/release.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Bump basedpyright to standard and fix errors</name>
  <files>pyproject.toml, src/aquacore/*.py (if fixes needed)</files>
  <action>
1. In pyproject.toml, change `typeCheckingMode = "basic"` to `typeCheckingMode = "standard"` under `[tool.basedpyright]`.

2. Run `hatch run typecheck` and capture output.

3. If errors appear, fix them. The 5 new rules in "standard" mode are:
   - reportFunctionMemberAccess: accessing non-existent attributes on function objects
   - reportIncompatibleMethodOverride: subclass method with incompatible signature
   - reportIncompatibleVariableOverride: unsafe attribute type narrowing
   - reportOverlappingOverload: ambiguous overload dispatch
   - reportPossiblyUnboundVariable: variable possibly undefined on some code paths
   Fix each error in the source file. Do NOT suppress with `# type: ignore` unless the error is a false positive from PyTorch tensor operations.

4. Re-run `hatch run typecheck` until 0 errors.

5. Run `hatch run test` to confirm no regressions from type annotation fixes.
  </action>
  <verify>`hatch run typecheck` outputs 0 errors; `hatch run test` passes</verify>
  <done>basedpyright at "standard" strictness reports 0 errors, 0 warnings, 0 notes; all tests pass</done>
</task>

<task type="auto">
  <name>Task 2: Validate CI workflows and fix gaps</name>
  <files>.github/workflows/test.yml, .github/workflows/publish.yml, .github/workflows/release.yml</files>
  <action>
Review each workflow for correctness against current codebase state. The workflows already exist and are well-configured per research. Validate:

1. **test.yml**: Verify it installs PyTorch. Currently it does `hatch env create` which installs deps from pyproject.toml. PyTorch is NOT in pyproject.toml dependencies (intentionally). Check if tests actually need torch at import time. If CI would fail because torch is missing, add a step to install torch CPU: `pip install torch --index-url https://download.pytorch.org/whl/cpu` BEFORE `hatch env create`. This is the critical gap â€” tests import aquacore which imports torch, but torch is not a declared dependency.

2. **test.yml**: Verify the test command handles the coverage flags correctly. Current: `hatch run test -- --cov --cov-report=xml --cov-report=term`. Confirm this works by running it locally.

3. **publish.yml**: Verify the build step uses `python -m build` which will use hatchling backend. Already correct per research. No changes expected.

4. **release.yml**: Verify the infinite loop guard (`if: "!startsWith(...)"`) is present. Already confirmed. No changes expected.

5. If torch installation is needed in test.yml, add it as a step after "Install Hatch" and before "Create environment":
   ```yaml
   - name: Install PyTorch (CPU)
     run: pip install torch torchvision --index-url https://download.pytorch.org/whl/cpu
   ```
   Also add the same step in publish.yml's test job.

6. Run `hatch run lint` and `hatch run format --check` to confirm lint passes (pre-commit CI job depends on this).
  </action>
  <verify>`hatch run lint` passes; `hatch run test -- --cov --cov-report=xml --cov-report=term` passes locally; workflow YAML is valid (no syntax errors)</verify>
  <done>All CI workflows validated; PyTorch installation gap addressed if needed; lint, typecheck, and test all pass locally with the same commands CI uses</done>
</task>

</tasks>

<verification>
- `hatch run typecheck` at "standard" shows 0 errors
- `hatch run test` passes (226+ tests)
- `hatch run lint` passes
- All workflow YAML files are syntactically valid
- PyTorch is available in CI test environments
</verification>

<success_criteria>
basedpyright standard mode passes clean, all CI commands pass locally, workflows are validated and any PyTorch installation gap is resolved.
</success_criteria>

<output>
After completion, create `.planning/phases/05-packaging-and-release/05-01-SUMMARY.md`
</output>
