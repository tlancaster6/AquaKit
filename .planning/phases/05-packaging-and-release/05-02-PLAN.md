---
phase: 05-packaging-and-release
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified: []
autonomous: false
user_setup:
  - service: github
    why: "Branch protection and repository settings"
    dashboard_config:
      - task: "Create RELEASE_TOKEN PAT with repo scope"
        location: "GitHub > Settings > Developer settings > Personal access tokens"
      - task: "Add RELEASE_TOKEN secret to repository"
        location: "GitHub repo > Settings > Secrets and variables > Actions"
      - task: "Create testpypi and pypi environments"
        location: "GitHub repo > Settings > Environments"
  - service: pypi
    why: "Trusted publishing registration"
    dashboard_config:
      - task: "Create aquacore project on PyPI (if not exists)"
        location: "https://pypi.org/manage/projects/"
      - task: "Register trusted publisher for publish.yml"
        location: "PyPI project > Publishing > Add trusted publisher"
      - task: "Same for TestPyPI"
        location: "https://test.pypi.org/manage/projects/"

must_haves:
  truths:
    - "Branch protection on main requires test, typecheck, and pre-commit status checks to pass"
    - "RELEASE_TOKEN secret exists and semantic-release can push version bumps"
    - "PyPI trusted publisher is registered for publish.yml workflow"
    - "GitHub environments testpypi and pypi exist"
  artifacts: []
  key_links:
    - from: ".github/workflows/release.yml"
      to: "GitHub secrets"
      via: "RELEASE_TOKEN PAT"
      pattern: "secrets.RELEASE_TOKEN"
    - from: ".github/workflows/publish.yml"
      to: "PyPI trusted publisher"
      via: "OIDC token exchange"
      pattern: "id-token: write"
---

<objective>
Configure GitHub repository settings and external service integrations required for CI and publishing to work end-to-end.

Purpose: The workflows exist but depend on GitHub secrets, environments, branch protection rules, and PyPI trusted publisher registration. These are human-required actions that Claude cannot perform via CLI.
Output: Fully configured GitHub repo and PyPI project ready for automated releases.
</objective>

<execution_context>
@C:/Users/tucke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/tucke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-packaging-and-release/05-RESEARCH.md
@.planning/phases/05-packaging-and-release/05-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit current GitHub repo configuration</name>
  <files></files>
  <action>
Use `gh` CLI to check current state of repository settings:

1. Check if RELEASE_TOKEN secret exists:
   `gh secret list` — look for RELEASE_TOKEN in output.

2. Check if GitHub environments exist:
   `gh api repos/{owner}/{repo}/environments` — look for `testpypi` and `pypi`.

3. Check if branch protection exists on main:
   `gh api repos/{owner}/{repo}/branches/main/protection` — check if rules exist and what checks are required.

4. Check if CODECOV_TOKEN secret exists:
   `gh secret list` — look for CODECOV_TOKEN (informational only, coverage is not a blocker).

5. Compile a report of what exists vs what needs to be created. Format as a checklist for the human-verify checkpoint.
  </action>
  <verify>`gh secret list` and `gh api` commands complete without auth errors</verify>
  <done>Complete audit of GitHub repository configuration state; clear list of what exists and what's missing</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Configure GitHub and PyPI settings</name>
  <files></files>
  <action>
Present audit results to user. The following items need human configuration in the GitHub UI and PyPI UI:

**GitHub Secrets (repo > Settings > Secrets and variables > Actions):**
1. If RELEASE_TOKEN is missing: Create a classic PAT at GitHub > Settings > Developer settings > Personal access tokens with `repo` scope. Add it as repository secret named `RELEASE_TOKEN`.
2. If CODECOV_TOKEN is missing (optional): Get token from codecov.io for your repo, add as secret.

**GitHub Environments (repo > Settings > Environments):**
3. Create environment `testpypi` if missing (no protection rules needed).
4. Create environment `pypi` if missing (optionally add "required reviewers" protection).

**PyPI Trusted Publisher:**
5. Go to https://pypi.org (create `aquacore` project if needed).
6. In project settings > Publishing > Add trusted publisher: Owner=`tlancaster6`, Repository=`aquacore`, Workflow=`publish.yml`, Environment=`pypi`.
7. Same on https://test.pypi.org with environment: `testpypi`.

**Branch Protection (repo > Settings > Branches > Add rule for `main`):**
8. Note: Status checks must have run at least once on main before they appear in the dropdown.
9. Configure: Require PR before merging, require status checks (`test`, `typecheck`, `pre-commit`), do NOT check "Include administrators".
  </action>
  <verify>User confirms all items configured by typing "done"</verify>
  <done>GitHub secrets, environments, branch protection, and PyPI trusted publisher are all configured</done>
</task>

</tasks>

<verification>
- `gh secret list` shows RELEASE_TOKEN
- `gh api repos/{owner}/{repo}/environments` shows testpypi and pypi
- `gh api repos/{owner}/{repo}/branches/main/protection` shows required status checks
</verification>

<success_criteria>
GitHub repository is fully configured: secrets set, environments created, branch protection active with required status checks, PyPI trusted publisher registered.
</success_criteria>

<output>
After completion, create `.planning/phases/05-packaging-and-release/05-02-SUMMARY.md`
</output>
